#include "quiz.h"
#include <algorithm>
#include <ctime>
#include <numeric>
#include <random>
#include <iostream>

Quiz::Quiz() 
    : currentQuestion(0)
    , finished(true)
    , retryMode(false)
    , retryRequired(false)
    , startTime(0)
    , requiredCorrectAnswers(0)
    , rng(static_cast<unsigned int>(time(nullptr))) {
    
    initializeQuestions();
}

void Quiz::initializeQuestions() {
    // ========== SUN (15 questions) ==========
    questions.push_back({
        L"Какая температура в ядре Солнца?",
        {L"1 миллион K", L"15 миллионов K", L"100 миллионов K", L"1 миллиард K"},
        1,
        L"Температура ядра Солнца составляет около 15 миллионов Кельвинов.",
        "sun", 2, 15
    });
    
    questions.push_back({
        L"Сколько времени требуется солнечному свету, чтобы достичь Земли?",
        {L"1 секунда", L"8 минут", L"1 час", L"1 день"},
        1,
        L"Солнечному свету требуется около 8 минут и 20 секунд, чтобы добраться от Солнца до Земли.",
        "sun", 1, 10
    });
    
    questions.push_back({
        L"Какой процент массы Солнечной системы составляет Солнце?",
        {L"50%", L"75%", L"90%", L"99,86%"},
        3,
        L"Солнце содержит 99,86% общей массы Солнечной системы.",
        "sun", 2, 15
    });
    
    questions.push_back({
        L"Какой основной элемент в составе Солнца?",
        {L"Гелий", L"Водород", L"Кислород", L"Углерод"},
        1,
        L"Солнце состоит примерно на 73% из водорода и на 25% из гелия по массе.",
        "sun", 1, 10
    });
    
    questions.push_back({
        L"Какова продолжительность солнечного цикла?",
        {L"1 год", L"11 лет", L"22 года", L"100 лет"},
        1,
        L"Солнечный цикл длится примерно 11 лет, что отмечается активностью солнечных пятен.",
        "sun", 3, 20
    });
    
    questions.push_back({
        L"Какой процесс обеспечивает энергию Солнца?",
        {L"Деление", L"Синтез", L"Горение", L"Гравитационное сжатие"},
        1,
        L"Ядерный синтез превращает водород в гелий, высвобождая огромную энергию.",
        "sun", 2, 15
    });
    
    questions.push_back({
        L"Сколько лет Солнцу?",
        {L"1 миллиард лет", L"4,6 миллиарда лет", L"10 миллиардов лет", L"13,8 миллиардов лет"},
        1,
        L"Солнцу около 4,6 миллиардов лет, оно прошло половину своего главного жизненного пути.",
        "sun", 2, 15
    });
    
    questions.push_back({
        L"Во что превратится Солнце в конце своей жизни?",
        {L"Нейтронная звезда", L"Черная дыра", L"Белый карлик", L"Красный гигант, затем белый карлик"},
        3,
        L"Солнце расширится в красного гиганта, затем сбросит внешние слои, оставив белого карлика.",
        "sun", 3, 20
    });
    
    questions.push_back({
        L"Что такое солнечные пятна?",
        {L"Солнечные вспышки", L"Более холодные области", L"Солнечные торнадо", L"Магнитные бури"},
        1,
        L"Солнечные пятна — это относительно холодные, темные области, вызванные интенсивной магнитной активностью.",
        "sun", 2, 15
    });
    
    questions.push_back({
        L"Что такое солнечный ветер?",
        {L"Горячий воздух", L"Поток заряженных частиц", L"Световые волны", L"Магнитное поле"},
        1,
        L"Солнечный ветер — это поток заряженных частиц, испускаемых из солнечной короны.",
        "sun", 2, 15
    });
    
    questions.push_back({
        L"Каков диаметр Солнца?",
        {L"100 000 км", L"1,4 миллиона км", L"10 миллионов км", L"100 миллионов км"},
        1,
        L"Диаметр Солнца составляет около 1,4 миллиона километров (в 109 раз больше диаметра Земли).",
        "sun", 1, 10
    });
    
    questions.push_back({
        L"Какой слой Солнца виден во время полного солнечного затмения?",
        {L"Фотосфера", L"Хромосфера", L"Корона", L"Ядро"},
        2,
        L"Корона, внешняя атмосфера Солнца, становится видимой во время полных солнечных затмений.",
        "sun", 3, 20
    });
    
    questions.push_back({
        L"Что такое солнечные вспышки?",
        {L"Взрывы на поверхности Солнца", L"Слияние солнечных пятен", L"Всплески солнечного ветра", L"Изменения магнитного поля"},
        0,
        L"Солнечные вспышки — это внезапные взрывы энергии, вызванные пересоединением магнитных полей.",
        "sun", 2, 15
    });
    
    questions.push_back({
        L"Сколько энергии производит Солнце каждую секунду?",
        {L"3,8 × 10^20 Дж", L"3,8 × 10^26 Дж", L"3,8 × 10^30 Дж", L"3,8 × 10^36 Дж"},
        1,
        L"Солнце производит около 3,8 × 10^26 джоулей в секунду посредством ядерного синтеза.",
        "sun", 3, 20
    });
    
    questions.push_back({
        L"Какова температура поверхности Солнца?",
        {L"2 700 K", L"5 778 K", L"10 000 K", L"15 000 K"},
        1,
        L"Температура поверхности Солнца (фотосферы) составляет около 5 778 Кельвинов.",
        "sun", 1, 10
    });
    
    // ========== MERCURY (15 questions) ==========
    questions.push_back({
        L"Какое положение Меркурия от Солнца?",
        {L"Первое", L"Второе", L"Третье", L"Четвертое"},
        0,
        L"Меркурий — первая планета от Солнца и самая маленькая в Солнечной системе.",
        "mercury", 1, 10
    });
    
    questions.push_back({
        L"Почему на Меркурии такие экстремальные перепады температуры?",
        {L"Нет атмосферы", L"Близко к Солнцу", L"Медленное вращение", L"Все вышеперечисленное"},
        3,
        L"У Меркурия почти нет атмосферы для удержания тепла, поэтому температура колеблется от -173°C до 427°C.",
        "mercury", 2, 15
    });
    
    questions.push_back({
        L"Сколько длится день на Меркурии?",
        {L"24 часа", L"59 земных дней", L"88 земных дней", L"176 земных дней"},
        3,
        L"Один день на Меркурии (один оборот) занимает 176 земных дней.",
        "mercury", 2, 15
    });
    
    questions.push_back({
        L"Каков орбитальный период Меркурия?",
        {L"88 земных дней", L"225 земных дней", L"365 земных дней", L"687 земных дней"},
        0,
        L"Меркурий обращается вокруг Солнца каждые 88 земных дней — самый короткий год среди всех планет.",
        "mercury", 1, 10
    });
    
    questions.push_back({
        L"Какой космический аппарат подробно изучал Меркурий?",
        {L"Вояджер-1", L"Кассини", L"Мессенджер", L"Новые горизонты"},
        2,
        L"Аппарат NASA MESSENGER вращался вокруг Меркурия с 2011 по 2015 год, предоставив подробные данные.",
        "mercury", 3, 20
    });
    
    questions.push_back({
        L"Какой самый большой объект на Меркурии?",
        {L"Олимп Монс", L"Бассейн Калорис", L"Большое Красное Пятно", L"Долины Маринер"},
        1,
        L"Бассейн Калорис — это огромный ударный кратер диаметром около 1 550 км.",
        "mercury", 2, 15
    });
    
    questions.push_back({
        L"Есть ли у Меркурия спутники?",
        {L"Да, 1", L"Да, 2", L"Нет", L"Да, но очень маленькие"},
        2,
        L"У Меркурия нет естественных спутников (лун).",
        "mercury", 1, 10
    });
    
    questions.push_back({
        L"Какова плотность Меркурия по сравнению с другими планетами?",
        {L"Самая низкая", L"Вторая по величине", L"Самая высокая", L"Средняя"},
        1,
        L"Меркурий имеет вторую по величине плотность после Земли, что указывает на большое железное ядро.",
        "mercury", 3, 20
    });
    
    questions.push_back({
        L"Что придает Меркурию серый цвет?",
        {L"Оксид железа", L"Силикатные породы", L"Водяной лед", L"Метановые облака"},
        1,
        L"Поверхность Меркурия в основном состоит из силикатных пород, что придает ему серый вид.",
        "mercury", 2, 15
    });
    
    questions.push_back({
        L"Где на Меркурии обнаружен водяной лед?",
        {L"На полюсах", L"На экваторе", L"Под поверхностью", L"В атмосфере"},
        0,
        L"Водяной лед существует в постоянно затененных кратерах на полюсах Меркурия.",
        "mercury", 3, 20
    });
    
    questions.push_back({
        L"Сколько бы весил человек массой 100 кг на Меркурии?",
        {L"38 кг", L"100 кг", L"150 кг", L"250 кг"},
        0,
        L"Гравитация Меркурия составляет 38% от земной, поэтому 100 кг ощущались бы как 38 кг.",
        "mercury", 2, 15
    });
    
    questions.push_back({
        L"Из чего состоит атмосфера Меркурия?",
        {L"Кислород и азот", L"Углекислый газ", L"Почти отсутствует", L"Водород и гелий"},
        2,
        L"У Меркурия чрезвычайно тонкая экзосфера, а не настоящая атмосфера.",
        "mercury", 1, 10
    });
    
    questions.push_back({
        L"Как, согласно теориям, сформировался Меркурий?",
        {L"Захваченный астероид", L"Гигантское столкновение сорвало внешние слои", L"Нормальная аккреция", L"Из материала Юпитера"},
        1,
        L"Популярная теория предполагает, что гигантское столкновение в ранней истории сорвало внешние слои Меркурия.",
        "mercury", 3, 20
    });
    
    questions.push_back({
        L"Что уникального в орбите Меркурия?",
        {L"Самая круговая", L"Самая эллиптическая", L"Ретроградная", L"Наклонена на бок"},
        1,
        L"У Меркурия самая эллиптическая орбита среди всех планет (эксцентриситет 0,2056).",
        "mercury", 2, 15
    });
    
    questions.push_back({
        L"Сколько раз космические аппараты посещали Меркурий?",
        {L"Никогда", L"Один раз", L"Два раза", L"Три раза"},
        2,
        L"Меркурий посещали Маринер-10 (1974-75) и MESSENGER (2008-2015).",
        "mercury", 2, 15
    });
    
    questions.push_back({
        L"Какое магнитное поле у Меркурия?",
        {L"Отсутствует", L"Очень слабое", L"Похоже на земное", L"Самое сильное в Солнечной системе"},
        1,
        L"У Меркурия слабое магнитное поле, около 1% от силы земного.",
        "mercury", 3, 20
    });
    
    // ========== VENUS (15 questions) ==========
    questions.push_back({
        L"Почему Венеру называют 'сестрой Земли'?",
        {L"Такой же размер", L"Схожий состав", L"Схожая гравитация", L"Все вышеперечисленное"},
        3,
        L"Венера похожа на Землю по размеру, массе, плотности и составу.",
        "venus", 1, 10
    });
    
    questions.push_back({
        L"Какой основной компонент атмосферы Венеры?",
        {L"Кислород", L"Азот", L"Углекислый газ", L"Метан"},
        2,
        L"Атмосфера Венеры на 96,5% состоит из углекислого газа, что вызывает экстремальный парниковый эффект.",
        "venus", 1, 10
    });
    
    questions.push_back({
        L"Насколько горяча поверхность Венеры?",
        {L"100°C", L"250°C", L"462°C", L"600°C"},
        2,
        L"Венера имеет самую высокую температуру поверхности среди всех планет — около 462°C.",
        "venus", 1, 10
    });
    
    questions.push_back({
        L"Что уникального во вращении Венеры?",
        {L"Самое быстрое", L"Ретроградное", L"Приливно заблокирована", L"Наклонена на бок"},
        1,
        L"Венера вращается в обратном направлении (ретроградно) по сравнению с большинством планет.",
        "venus", 2, 15
    });
    
    questions.push_back({
        L"Сколько длится день на Венере?",
        {L"24 часа", L"243 земных дня", L"117 земных дней", L"58 земных дней"},
        1,
        L"Один день на Венере (оборот) составляет 243 земных дня — дольше, чем ее год!",
        "venus", 2, 15
    });
    
    questions.push_back({
        L"Что покрывает поверхность Венеры?",
        {L"Океаны", L"Пустыни", L"Вулканические равнины", L"Ледяные шапки"},
        2,
        L"Около 80% Венеры покрыто гладкими вулканическими равнины.",
        "venus", 2, 15
    });
    
    questions.push_back({
        L"Из чего состоят облака Венеры?",
        {L"Водяной пар", L"Серная кислота", L"Лед углекислого газа", L"Аммиак"},
        1,
        L"Облака Венеры состоят из капель серной кислоты.",
        "venus", 3, 20
    });
    
    questions.push_back({
        L"Какой космический аппарат первым совершил посадку на Венеру?",
        {L"Венера-7", L"Викинг-1", L"Маринер-2", L"Пионер-Венера"},
        0,
        L"Венера-7 (СССР) совершила первую успешную посадку на Венеру в 1970 году.",
        "venus", 3, 20
    });
    
    questions.push_back({
        L"Какое атмосферное давление на Венере?",
        {L"Как на Земле", L"В 10 раз больше земного", L"В 50 раз больше земного", L"В 92 раза больше земного"},
        3,
        L"Давление на поверхности Венеры примерно в 92 раза превышает земное атмосферное давление.",
        "venus", 2, 15
    });
    
    questions.push_back({
        L"Есть ли у Венеры спутники?",
        {L"Да, 1", L"Да, 2", L"Нет", L"Да, но очень маленькие"},
        2,
        L"У Венеры нет естественных спутников.",
        "venus", 1, 10
    });
    
    questions.push_back({
        L"Какая самая высокая гора на Венере?",
        {L"Олимп Монс", L"Горы Максвелла", L"Гора Маат", L"Гора Скади"},
        1,
        L"Горы Максвелла высотой около 11 км, выше земной Эверест.",
        "venus", 3, 20
    });
    
    questions.push_back({
        L"Почему мы не можем видеть поверхность Венеры из космоса?",
        {L"Слишком далеко", L"Густые облака", L"Нет света", L"Атмосферные искажения"},
        1,
        L"Плотные облака серной кислоты полностью скрывают поверхность Венеры от обзора.",
        "venus", 1, 10
    });
    
    questions.push_back({
        L"Каков орбитальный период Венеры?",
        {L"88 дней", L"225 дней", L"365 дней", L"687 дней"},
        1,
        L"Венера обращается вокруг Солнца каждые 225 земных дней.",
        "venus", 1, 10
    });
    
    questions.push_back({
        L"Какое явление происходит, когда Венера проходит между Землей и Солнцем?",
        {L"Солнечное затмение", L"Лунное затмение", L"Прохождение Венеры", L"Закрытие Венеры"},
        2,
        L"Прохождения Венеры — редкие астрономические события, когда Венера пересекает диск Солнца.",
        "venus", 3, 20
    });
    
    questions.push_back({
        L"Что такое 'пепельный свет' Венеры?",
        {L"Полярные сияния", L"Свечение ночной стороны", L"Молнии", L"Вулканические извержения"},
        1,
        L"Пепельный свет — это слабое свечение, наблюдаемое на ночной стороне Венеры, возможно, вызванное электрической активностью.",
        "venus", 3, 20
    });
    
    questions.push_back({
        L"Сколько вулканов примерно на Венере?",
        {L"100", L"1 000", L"10 000", L"Более 100 000"},
        3,
        L"На Венере больше вулканов, чем на любой другой планете, с оценками более 100 000.",
        "venus", 2, 15
    });
    
    // ========== EARTH (15 questions) ==========
    questions.push_back({
        L"Какой процент поверхности Земли покрыт водой?",
        {L"50%", L"71%", L"85%", L"95%"},
        1,
        L"Около 71% поверхности Земли покрыто водой, в основном океанами.",
        "earth", 1, 10
    });
    
    questions.push_back({
        L"Какой единственный естественный спутник у Земли?",
        {L"Фобос", L"Деймос", L"Луна", L"Титан"},
        2,
        L"Луна — единственный естественный спутник Земли и пятый по величине в Солнечной системе.",
        "earth", 1, 10
    });
    
    questions.push_back({
        L"Что защищает Землю от солнечной радиации?",
        {L"Озоновый слой", L"Магнитное поле", L"Атмосфера", L"Все вышеперечисленное"},
        3,
        L"Магнитное поле Земли, атмосфера и озоновый слой обеспечивают защиту.",
        "earth", 2, 15
    });
    
    questions.push_back({
        L"Каков наклон оси Земли?",
        {L"0°", L"23,5°", L"45°", L"90°"},
        1,
        L"Ось Земли наклонена на 23,5 градуса относительно ее орбитальной плоскости, что вызывает смену времен года.",
        "earth", 1, 10
    });
    
    questions.push_back({
        L"Какая самая глубокая точка в океанах Земли?",
        {L"Желоб Пуэрто-Рико", L"Зондский желоб", L"Марианская впадина", L"Желоб Тонга"},
        2,
        L"Марианская впадина в Тихом океане достигает глубины около 11 км.",
        "earth", 2, 15
    });
    
    questions.push_back({
        L"Какой слой Земли содержит тектонические плиты?",
        {L"Внутреннее ядро", L"Внешнее ядро", L"Мантия", L"Литосфера"},
        3,
        L"Литосфера (кора и верхняя мантия) разбита на тектонические плиты.",
        "earth", 2, 15
    });
    
    questions.push_back({
        L"Какой основной газ в атмосфере Земли?",
        {L"Кислород", L"Азот", L"Углекислый газ", L"Аргон"},
        1,
        L"Атмосфера Земли состоит на 78% из азота и на 21% из кислорода.",
        "earth", 1, 10
    });
    
    questions.push_back({
        L"Сколько лет Земле?",
        {L"1 миллиард лет", L"4,54 миллиарда лет", L"10 миллиардов лет", L"13,8 миллиардов лет"},
        1,
        L"Земля сформировалась около 4,54 миллиардов лет назад из солнечной туманности.",
        "earth", 2, 15
    });
    
    questions.push_back({
        L"Что вызывает магнитное поле Земли?",
        {L"Твердое железное ядро", L"Жидкое железное внешнее ядро", L"Конвекция мантии", L"Солнечный ветер"},
        1,
        L"Магнитное поле Земли генерируется движением расплавленного железа во внешнем ядре.",
        "earth", 3, 20
    });
    
    questions.push_back({
        L"Какая самая высокая точка на Земле?",
        {L"Эверест", L"Мауна-Кеа", L"Чимборасо", L"K2"},
        0,
        L"Вершина Эвереста находится на высоте 8 848 метров над уровнем моря.",
        "earth", 1, 10
    });
    
    questions.push_back({
        L"Как назывался суперконтинент Земли 300 миллионов лет назад?",
        {L"Родиния", L"Пангея", L"Гондвана", L"Лавразия"},
        1,
        L"Пангея была суперконтинентом, существовавшим в позднем палеозое.",
        "earth", 3, 20
    });
    
    questions.push_back({
        L"Какой процент воды на Земле является пресной?",
        {L"1%", L"3%", L"10%", L"25%"},
        1,
        L"Только около 3% воды на Земле является пресной, большая часть которой заморожена в ледяных шапках.",
        "earth", 2, 15
    });
    
    questions.push_back({
        L"Какова основная функция озонового слоя?",
        {L"Производит кислород", L"Блокирует УФ-излучение", L"Регулирует температуру", L"Создает погоду"},
        1,
        L"Озоновый слой поглощает 97-99% вредного ультрафиолетового излучения Солнца.",
        "earth", 2, 15
    });
    
    questions.push_back({
        L"Какова средняя орбитальная скорость Земли?",
        {L"10 км/с", L"30 км/с", L"100 км/с", L"300 км/с"},
        1,
        L"Земля обращается вокруг Солнца со средней скоростью около 30 км/с (108 000 км/ч).",
        "earth", 2, 15
    });
    
    questions.push_back({
        L"Что такое 'зона Златовласки'?",
        {L"Регион с жидкой водой", L"Область с жизнью", L"Обитаемая зона вокруг звезды", L"Все вышеперечисленное"},
        3,
        L"Обитаемая зона, где условия позволяют существование жидкой воды на поверхности планеты.",
        "earth", 3, 20
    });
    
    // ========== MARS (15 questions) ==========
    questions.push_back({
        L"Почему Марс называют 'Красной планетой'?",
        {L"Красная растительность", L"Пыль из оксида железа", L"Вулканические минералы", L"Атмосферная рефракция"},
        1,
        L"Оксид железа (ржавчина) в марсианской почве придает ей красноватый вид.",
        "mars", 1, 10
    });
    
    questions.push_back({
        L"Какой самый большой вулкан в Солнечной системе?",
        {L"Мауна-Лоа", L"Олимп Монс", L"Элизиум Монс", L"Арсия Монс"},
        1,
        L"Олимп Монс на Марсе имеет высоту около 22 км и ширину 600 км.",
        "mars", 2, 15
    });
    
    questions.push_back({
        L"Сколько спутников у Марса?",
        {L"Нет", L"1", L"2", L"4"},
        2,
        L"У Марса два небольших спутника: Фобос и Деймос.",
        "mars", 1, 10
    });
    
    questions.push_back({
        L"Какой самый большой каньон в Солнечной системе?",
        {L"Гранд-Каньон", L"Долины Маринер", L"Хаос Бореалис", L"Равнина Эллада"},
        1,
        L"Долины Маринер имеют длину около 4 000 км, ширину 200 км и глубину до 7 км.",
        "mars", 2, 15
    });
    
    questions.push_back({
        L"Из чего в основном состоит атмосфера Марса?",
        {L"Кислород", L"Азот", L"Углекислый газ", L"Метан"},
        2,
        L"Тонкая атмосфера Марса на 95% состоит из углекислого газа.",
        "mars", 1, 10
    });
    
    questions.push_back({
        L"Какие доказательства указывают, что на Марсе когда-то была жидкая вода?",
        {L"Речные долины", L"Ложа озер", L"Минеральные отложения", L"Все вышеперечисленное"},
        3,
        L"Множественные доказательства показывают, что на Марсе в прошлом была текущая вода.",
        "mars", 2, 15
    });
    
    questions.push_back({
        L"Сколько длится марсианский день (сол)?",
        {L"24 часа", L"24ч 37м", L"25ч", L"30ч"},
        1,
        L"Марсианский день (сол) длится около 24 часов и 37 минут.",
        "mars", 1, 10
    });
    
    questions.push_back({
        L"Каков орбитальный период Марса?",
        {L"225 дней", L"365 дней", L"687 дней", L"1 000 дней"},
        2,
        L"Марсу требуется около 687 земных дней для обращения вокруг Солнца.",
        "mars", 1, 10
    });
    
    questions.push_back({
        L"Какой марсоход обнаружил доказательства древних пресноводных озер?",
        {L"Соджорнер", L"Спирит", L"Оппортьюнити", L"Кьюриосити"},
        3,
        L"Марсоход Кьюриосити нашел доказательства древних пресноводных озер в кратере Гейл.",
        "mars", 3, 20
    });
    
    questions.push_back({
        L"Из чего состоят полярные шапки Марса?",
        {L"Только водяной лед", L"Только сухой лед", L"Водяной и сухой лед", L"Метановый лед"},
        2,
        L"Полярные шапки Марса содержат как водяной лед, так и замороженный углекислый газ (сухой лед).",
        "mars", 2, 15
    });
    
    questions.push_back({
        L"Что вызывает глобальные пылевые бури на Марсе?",
        {L"Сильные ветры", L"Низкая гравитация", L"Сезонные изменения", L"Все вышеперечисленное"},
        3,
        L"Марсианские пылевые бури могут разрастаться и покрывать всю планету из-за тонкой атмосферы и сезонных изменений.",
        "mars", 3, 20
    });
    
    questions.push_back({
        L"Какая самая высокая гора в Солнечной системе?",
        {L"Мауна-Кеа", L"Эверест", L"Олимп Монс", L"Горы Максвелла"},
        2,
        L"Олимп Монс высотой около 22 км, почти в 3 раза выше Эвереста.",
        "mars", 2, 15
    });
    
    questions.push_back({
        L"Какая миссия первой успешно совершила посадку на Марс?",
        {L"Маринер-4", L"Викинг-1", L"Пасфайндер", L"Марс-2"},
        1,
        L"Викинг-1 совершил первую успешную мягкую посадку на Марс в 1976 году.",
        "mars", 3, 20
    });
    
    questions.push_back({
        L"Какой самый большой ударный бассейн на Марсе?",
        {L"Равнина Эллада", L"Утопия Планития", L"Исидис Планития", L"Аргире Планития"},
        0,
        L"Равнина Эллада имеет диаметр около 2 300 км и глубину 7 км.",
        "mars", 3, 20
    });
    
    questions.push_back({
        L"Что необычного в марсианском спутнике Фобосе?",
        {L"Обращается в обратную сторону", L"Упадет на Марс", L"Имеет атмосферу", L"Сделан из металла"},
        1,
        L"Фобос медленно приближается к Марсу и, вероятно, столкнется с ним через 30-50 миллионов лет.",
        "mars", 3, 20
    });
    
    // ========== JUPITER (15 questions) ==========
    questions.push_back({
        L"Какая самая известная особенность Юпитера?",
        {L"Большое Темное Пятно", L"Большое Красное Пятно", L"Шестиугольный шторм", L"Полярный вихрь"},
        1,
        L"Большое Красное Пятно — это гигантский шторм, бушующий как минимум 400 лет.",
        "jupiter", 1, 10
    });
    
    questions.push_back({
        L"Сколько Земель может поместиться внутри Юпитера?",
        {L"11", L"132", L"1 000", L"1 321"},
        3,
        L"Внутри Юпитера может поместиться около 1 321 Земля по объему.",
        "jupiter", 1, 10
    });
    
    questions.push_back({
        L"Из чего в основном состоит Юпитер?",
        {L"Камень и металл", L"Водород и гелий", L"Вода и аммиак", L"Метан"},
        1,
        L"Юпитер примерно на 90% состоит из водорода и на 10% из гелия, что схоже с составом Солнца.",
        "jupiter", 1, 10
    });
    
    questions.push_back({
        L"Сколько известно спутников у Юпитера?",
        {L"4", L"16", L"79", L"95"},
        3,
        L"У Юпитера есть как минимум 79 известных спутников — самое большое количество в Солнечной системе.",
        "jupiter", 2, 15
    });
    
    questions.push_back({
        L"Какие четыре крупнейших спутника Юпитера?",
        {L"Галилеевы спутники", L"Титанические спутники", L"Основные спутники", L"Первичные спутники"},
        0,
        L"Ио, Европа, Ганимед и Каллисто называются галилеевыми спутниками.",
        "jupiter", 1, 10
    });
    
    questions.push_back({
        L"Сколько длится день на Юпитере?",
        {L"10 часов", L"24 часа", L"9ч 56м", L"12 часов"},
        0,
        L"У Юпитера самый короткий день среди всех планет — около 10 часов.",
        "jupiter", 2, 15
    });
    
    questions.push_back({
        L"Что уникального в спутнике Юпитера Ио?",
        {L"Самый вулканически активный", L"Имеет океаны", L"Самый большой", L"Обращается в обратную сторону"},
        0,
        L"Ио — самое вулканически активное тело в Солнечной системе.",
        "jupiter", 2, 15
    });
    
    questions.push_back({
        L"Что может существовать под льдом Европы?",
        {L"Вулканы", L"Жидкий океан", L"Металлическое ядро", L"Алмазные горы"},
        1,
        L"Ученые считают, что под ледяной коркой Европы существует соленый жидкий океан.",
        "jupiter", 2, 15
    });
    
    questions.push_back({
        L"Какой космический аппарат сейчас изучает Юпитер?",
        {L"Вояджер-2", L"Кассини", L"Юнона", L"Галилео"},
        2,
        L"Космический аппарат NASA Юнона вращается вокруг Юпитера с 2016 года.",
        "jupiter", 3, 20
    });
    
    questions.push_back({
        L"Каков орбитальный период Юпитера?",
        {L"1 год", L"12 лет", L"29 лет", L"84 лет"},
        1,
        L"Юпитеру требуется около 12 земных лет для обращения вокруг Солнца.",
        "jupiter", 1, 10
    });
    
    questions.push_back({
        L"Насколько сильное магнитное поле у Юпитера?",
        {L"Слабее земного", L"Похоже на земное", L"В 10 раз сильнее земного", L"В 20 000 раз сильнее земного"},
        3,
        L"Магнитное поле Юпитера самое сильное в Солнечной системе — примерно в 20 000 раз сильнее земного.",
        "jupiter", 3, 20
    });
    
    questions.push_back({
        L"Из чего состоят кольца Юпитера?",
        {L"Ледяные частицы", L"Пыль", L"Осколки пород", L"Все вышеперечисленное"},
        1,
        L"У Юпитера есть слабые кольца, состоящие в основном из пыли от ударов микрометеоритов о спутники.",
        "jupiter", 3, 20
    });
    
    questions.push_back({
        L"Какой спутник самый большой в Солнечной системе?",
        {L"Титан", L"Ганимед", L"Луна", L"Каллисто"},
        1,
        L"Ганимед больше Меркурия и единственный спутник с собственным магнитным полем.",
        "jupiter", 2, 15
    });
    
    questions.push_back({
        L"Что вызывает полосатый вид Юпитера?",
        {L"Слои облаков", L"Магнитные поля", L"Штормы", L"Все вышеперечисленное"},
        3,
        L"Полосы Юпитера создаются различными слоями облаков и циркуляцией атмосферы.",
        "jupiter", 3, 20
    });
    
    questions.push_back({
        L"Сколько энергии Юпитер излучает по сравнению с получаемой?",
        {L"Меньше", L"Столько же", L"В 1,7 раза больше", L"В 100 раз больше"},
        2,
        L"Юпитер излучает примерно в 1,7 раза больше тепла, чем получает от Солнца, из-за гравитационного сжатия.",
        "jupiter", 3, 20
    });
    
    // ========== SATURN (15 questions) ==========
    questions.push_back({
        L"Чем знаменит Сатурн?",
        {L"Большое Красное Пятно", L"Кольца", L"Много спутников", L"Все вышеперечисленное"},
        1,
        L"Сатурн наиболее известен своей впечатляющей системой колец.",
        "saturn", 1, 10
    });
    
    questions.push_back({
        L"Из чего состоят кольца Сатурна?",
        {L"Твердый лед", L"Пыль и лед", L"Осколки пород", L"Газовые облака"},
        1,
        L"Кольца Сатурна в основном состоят из частиц водяного льда размером от пыли до гор.",
        "saturn", 1, 10
    });
    
    questions.push_back({
        L"Сколько основных колец у Сатурна?",
        {L"3", L"7", L"13", L"Тысячи"},
        1,
        L"У Сатурна 7 основных колец, обозначенных буквами от A до G, со сложной подструктурой.",
        "saturn", 2, 15
    });
    
    questions.push_back({
        L"Что уникального в плотности Сатурна?",
        {L"Самая высокая", L"Самая низкая", L"Как у воды", L"Переменная"},
        2,
        L"Сатурн — единственная планета, менее плотная, чем вода — он бы плавал в гигантской ванне!",
        "saturn", 2, 15
    });
    
    questions.push_back({
        L"Сколько спутников у Сатурна?",
        {L"62", L"82", L"95", L"Более 100"},
        2,
        L"У Сатурна 82 подтвержденных спутника, что уступает только Юпитеру.",
        "saturn", 2, 15
    });
    
    questions.push_back({
        L"Какой самый большой спутник Сатурна?",
        {L"Титан", L"Рея", L"Япет", L"Диона"},
        0,
        L"Титан — самый большой спутник Сатурна и второй по величине в Солнечной системе.",
        "saturn", 1, 10
    });
    
    questions.push_back({
        L"Что уникального в Титане?",
        {L"Имеет атмосферу", L"Имеет жидкие озера", L"Оба варианта", L"Ничего из перечисленного"},
        2,
        L"Титан имеет плотную атмосферу и жидкие озера метана/этана на поверхности.",
        "saturn", 2, 15
    });
    
    questions.push_back({
        L"Какую форму имеет Сатурн?",
        {L"Идеальная сфера", L"Слегка сплюснутая", L"Сфероид", L"Очень сплюснутый"},
        3,
        L"Сатурн — самая сплюснутая планета из-за быстрого вращения и низкой плотности.",
        "saturn", 3, 20
    });
    
    questions.push_back({
        L"Какой толщины кольца Сатурна?",
        {L"1 км", L"10 метров", L"100 метров", L"Разная"},
        1,
        L"Большинство колец Сатурна имеют толщину всего около 10 метров, несмотря на ширину 280 000 км.",
        "saturn", 3, 20
    });
    
    questions.push_back({
        L"Что вызывает промежутки в кольцах Сатурна?",
        {L"Резонансы с лунами", L"Спутники-пастухи", L"Оба варианта", L"Неизвестно"},
        2,
        L"Луны создают промежутки через гравитационные резонансы и эффекты спутников-пастухов.",
        "saturn", 3, 20
    });
    
    questions.push_back({
        L"Какой космический аппарат подробно изучал Сатурн?",
        {L"Вояджер-2", L"Кассини", L"Галилео", L"Новые горизонты"},
        1,
        L"Миссия Кассини-Гюйгенс вращалась вокруг Сатурна 13 лет (2004-2017).",
        "saturn", 2, 15
    });
    
    questions.push_back({
        L"Каков орбитальный период Сатурна?",
        {L"12 лет", L"29,5 лет", L"84 года", L"165 лет"},
        1,
        L"Сатурну требуется около 29,5 земных лет для обращения вокруг Солнца.",
        "saturn", 1, 10
    });
    
    questions.push_back({
        L"Что такое шестиугольник на северном полюсе Сатурна?",
        {L"Шторм", L"Образование облаков", L"Полярный вихрь", L"Все вышеперечисленное"},
        3,
        L"Постоянное шестиугольное облачное образование вращается вокруг северного полюса Сатурна.",
        "saturn", 3, 20
    });
    
    questions.push_back({
        L"Что такое спутники-пастухи?",
        {L"Луны, которые пасут частицы колец", L"Самые большие луны", L"Самые внутренние луны", L"Ледяные луны"},
        0,
        L"Маленькие луны, которые гравитационно ограничивают материал колец в узкие кольца.",
        "saturn", 3, 20
    });
    
    questions.push_back({
        L"Чем известен Энцелад?",
        {L"Гейзеры", L"Вулканы", L"Плотная атмосфера", L"Ретроградная орбита"},
        0,
        L"Энцелад извергает водяные гейзеры из своего южного полярного региона, что указывает на подповерхностный океан.",
        "saturn", 3, 20
    });
    
    // ========== URANUS (15 questions) ==========
    questions.push_back({
        L"Что уникального во вращении Урана?",
        {L"Самое быстрое", L"Ретроградное", L"Наклонен на бок", L"Приливно заблокирован"},
        2,
        L"Уран вращается почти на боку — его ось наклонена на 98 градусов.",
        "uranus", 1, 10
    });
    
    questions.push_back({
        L"Что придает Урану сине-зеленый цвет?",
        {L"Вода", L"Метан", L"Аммиак", L"Гелий"},
        1,
        L"Метан в атмосфере Урана поглощает красный свет, придавая ему сине-зеленый вид.",
        "uranus", 1, 10
    });
    
    questions.push_back({
        L"Как был открыт Уран?",
        {L"В древние времена", L"Телескопом в 1690", L"Гершелем в 1781", L"Снимками космического аппарата"},
        2,
        L"Уильям Гершель открыл Уран в 1781 году — первая планета, открытая с помощью телескопа.",
        "uranus", 2, 15
    });
    
    questions.push_back({
        L"Сколько колец у Урана?",
        {L"Нет", L"3", L"13", L"1000"},
        2,
        L"У Урана 13 известных колец, впервые открытых в 1977 году.",
        "uranus", 2, 15
    });
    
    questions.push_back({
        L"Каков орбитальный период Урана?",
        {L"29 лет", L"84 года", L"165 лет", L"248 лет"},
        1,
        L"Урану требуется около 84 земных лет для обращения вокруг Солнца.",
        "uranus", 1, 10
    });
    
    questions.push_back({
        L"Сколько спутников у Урана?",
        {L"5", L"13", L"27", L"50"},
        2,
        L"У Урана 27 известных спутников, названных в честь персонажей Шекспира.",
        "uranus", 2, 15
    });
    
    questions.push_back({
        L"Какие самые большие спутники Урана?",
        {L"Галилеевы спутники", L"Основные спутники", L"Пять крупнейших", L"Все маленькие"},
        2,
        L"Титания, Оберон, Умбриэль, Ариэль и Миранда — пять крупнейших.",
        "uranus", 2, 15
    });
    
    questions.push_back({
        L"Какой космический аппарат посещал Уран?",
        {L"Вояджер-2", L"Кассини", L"Новые горизонты", L"Ни один"},
        0,
        L"Вояджер-2 пролетел мимо Урана в 1986 году, предоставив большую часть наших знаний.",
        "uranus", 2, 15
    });
    
    questions.push_back({
        L"Какая необычная особенность у Миранды?",
        {L"Гейзеры", L"Верона Рупес", L"Ретроградная орбита", L"Атмосфера"},
        1,
        L"У Миранды есть Верона Рупес — обрыв, возможно, высотой 20 км, самый высокий в Солнечной системе.",
        "uranus", 3, 20
    });
    
    questions.push_back({
        L"Какой сезон длится 42 года на Уране?",
        {L"Весна", L"Лето", L"Зима", L"Все сезоны"},
        3,
        L"Каждый сезон на Уране длится около 21 года, с 42 годами непрерывного солнечного света или темноты на полюсах.",
        "uranus", 3, 20
    });
    
    questions.push_back({
        L"Что необычного в магнитном поле Урана?",
        {L"Самое сильное", L"Наклонено на 60°", L"Сосредоточено", L"Множество полюсов"},
        1,
        L"Магнитное поле Урана наклонено на 60 градусов от его оси вращения.",
        "uranus", 3, 20
    });
    
    questions.push_back({
        L"Какова температура ядра Урана?",
        {L"5 000 К", L"10 000 К", L"15 000 К", L"20 000 К"},
        0,
        L"Температура ядра Урана составляет около 5 000 К, что намного холоднее, чем у других газовых гигантов.",
        "uranus", 3, 20
    });
    
    questions.push_back({
        L"Почему Уран — 'ледяной гигант'?",
        {L"Сделан из льда", L"Очень холодный", L"Мантия из воды/аммиака", L"Все вышеперечисленное"},
        2,
        L"У Урана есть мантия из водяного, аммиачного и метанового льда, окружающая каменное ядро.",
        "uranus", 3, 20
    });
    
    questions.push_back({
        L"Какая планета самая холодная?",
        {L"Нептун", L"Уран", L"Сатурн", L"Плутон"},
        1,
        L"У Урана самая холодная атмосфера в Солнечной системе при -224°C.",
        "uranus", 2, 15
    });
    
    questions.push_back({
        L"Что необычного в некоторых спутниках Урана?",
        {L"Ретроградные", L"Пастухи колец", L"Орбиты в кольцах", L"Все вышеперечисленное"},
        3,
        L"Некоторые маленькие луны вращаются внутри кольцевой системы Урана, действуя как спутники-пастухи.",
        "uranus", 3, 20
    });
    
    // ========== NEPTUNE (15 questions) ==========
    questions.push_back({
        L"Как был открыт Нептун?",
        {L"В древние времена", L"Наблюдения в телескоп", L"Математические расчеты", L"Космическим аппаратом"},
        2,
        L"Нептун был математически предсказан до наблюдения, на основе орбиты Урана.",
        "neptune", 1, 10
    });
    
    questions.push_back({
        L"Какая самая известная особенность Нептуна?",
        {L"Большое Красное Пятно", L"Большое Темное Пятно", L"Шестиугольник", L"Полярный вихрь"},
        1,
        L"У Нептуна было Большое Темное Пятно, похожее на Большое Красное Пятно Юпитера, но оно исчезло.",
        "neptune", 1, 10
    });
    
    questions.push_back({
        L"Что придает Нептуну синий цвет?",
        {L"Вода", L"Метан", L"Аммиак", L"Гелий"},
        1,
        L"Как и на Уране, метан поглощает красный свет, но Нептун темнее синего по неизвестным причинам.",
        "neptune", 1, 10
    });
    
    questions.push_back({
        L"Насколько быстры ветры на Нептуне?",
        {L"100 км/ч", L"500 км/ч", L"2 100 км/ч", L"5 000 км/ч"},
        2,
        L"На Нептуне самые быстрые ветры в Солнечной системе — до 2 100 км/ч.",
        "neptune", 2, 15
    });
    
    questions.push_back({
        L"Сколько спутников у Нептуна?",
        {L"1", L"8", L"14", L"27"},
        2,
        L"У Нептуна 14 известных спутников, Тритон — самый большой.",
        "neptune", 2, 15
    });
    
    questions.push_back({
        L"Что уникального в Тритоне?",
        {L"Самый большой спутник", L"Ретроградная орбита", L"Геологически активен", L"Все вышеперечисленное"},
        3,
        L"Тритон обращается в обратную сторону, больше Плутона и имеет активные гейзеры.",
        "neptune", 2, 15
    });
    
    questions.push_back({
        L"Какой космический аппарат посещал Нептун?",
        {L"Вояджер-2", L"Кассини", L"Новые горизонты", L"Ни один"},
        0,
        L"Вояджер-2 пролетел мимо Нептуна в 1989 году — наше единственное близкое сближение.",
        "neptune", 2, 15
    });
    
    questions.push_back({
        L"Каков орбитальный период Нептуна?",
        {L"84 года", L"165 лет", L"248 лет", L"500 лет"},
        1,
        L"Нептуну требуется около 165 земных лет для обращения вокруг Солнца.",
        "neptune", 1, 10
    });
    
    questions.push_back({
        L"Из чего состоят гейзеры Тритона?",
        {L"Вода", L"Азот", L"Метан", L"Углекислый газ"},
        1,
        L"Гейзеры Тритона извергают азотный газ и темные частицы пыли.",
        "neptune", 3, 20
    });
    
    questions.push_back({
        L"Сколько колец у Нептуна?",
        {L"Нет", L"3", L"5", L"13"},
        2,
        L"У Нептуна 5 основных колец, названных в честь астрономов: Галле, Леверье, Лассаль, Араго и Адамс.",
        "neptune", 3, 20
    });
    
    questions.push_back({
        L"Что уникального в кольцевых дугах Нептуна?",
        {L"Полные кольца", L"Комковатые дуги", L"Спиральная форма", L"Множество цветов"},
        1,
        L"Кольца Нептуна имеют яркие комковатые дуги, особенно в кольце Адамс.",
        "neptune", 3, 20
    });
    
    questions.push_back({
        L"Как внутреннее тепло Нептуна сравнивается с Ураном?",
        {L"Такое же", L"Меньше", L"В 2,6 раза больше", L"В 10 раз больше"},
        2,
        L"Нептун излучает в 2,6 раза больше тепла, чем получает, в то время как Уран почти не излучает.",
        "neptune", 3, 20
    });
    
    questions.push_back({
        L"Что в конечном итоге произойдет с Тритоном?",
        {L"Столкнется с Нептуном", L"Улетит", L"Распадется", L"Станет планетой"},
        0,
        L"Ретроградная орбита Тритона разрушается, и в конечном итоге его разорвет гравитация Нептуна.",
        "neptune", 3, 20
    });
    
    questions.push_back({
        L"Какой сезон длится 40 лет на Нептуне?",
        {L"Весна", L"Лето", L"Зима", L"Все сезоны"},
        3,
        L"Как и на Уране, сезоны на Нептуне длятся около 40 лет каждый из-за его длинной орбиты.",
        "neptune", 3, 20
    });
    
    questions.push_back({
        L"Какой самый большой спутник Нептуна?",
        {L"Тритон", L"Нереида", L"Протей", L"Ларисса"},
        0,
        L"Тритон составляет 99,5% массы, вращающейся вокруг Нептуна.",
        "neptune", 2, 15
    });
    
    // ========== PLUTO (10 questions) ==========
    questions.push_back({
        L"Когда Плутон был переклассифицирован как карликовая планета?",
        {L"1999", L"2006", L"2015", L"2020"},
        1,
        L"МАС переклассифицировал Плутон как карликовую планету в 2006 году.",
        "pluto", 1, 10
    });
    
    questions.push_back({
        L"Сколько спутников у Плутона?",
        {L"Нет", L"1", L"5", L"7"},
        2,
        L"У Плутона 5 известных спутников: Харон, Стикс, Никта, Кербер и Гидра.",
        "pluto", 1, 10
    });
    
    questions.push_back({
        L"Что уникального в системе Плутон-Харон?",
        {L"Двойная система", L"Оба имеют атмосферы", L"Оба круглые", L"Все вышеперечисленное"},
        0,
        L"Плутон и Харон обращаются вокруг барицентра вне Плутона, делая их двойной системой.",
        "pluto", 2, 15
    });
    
    questions.push_back({
        L"Какой космический аппарат посещал Плутон?",
        {L"Вояджер-2", L"Новые горизонты", L"Кассини", L"Ни один"},
        1,
        L"Новые горизонты пролетели мимо Плутона в 2015 году, предоставив первые детальные изображения.",
        "pluto", 2, 15
    });
    
    questions.push_back({
        L"Что находится на поверхности Плутона?",
        {L"Горы водяного льда", L"Азотные ледники", L"Оба варианта", L"Ничего из перечисленного"},
        2,
        L"На Плутоне есть горы водяного льда и текущие азотные ледники.",
        "pluto", 3, 20
    });
    
    questions.push_back({
        L"Сколько длится орбитальный период Плутона?",
        {L"84 года", L"165 лет", L"248 лет", L"500 лет"},
        2,
        L"Плутону требуется около 248 земных лет для обращения вокруг Солнца.",
        "pluto", 2, 15
    });
    
    questions.push_back({
        L"Какой самый большой спутник Плутона?",
        {L"Харон", L"Никта", L"Гидра", L"Стикс"},
        0,
        L"Харон примерно вдвое меньше Плутона, необычно большой для спутника.",
        "pluto", 1, 10
    });
    
    questions.push_back({
        L"Что придает Плутону красноватый цвет?",
        {L"Оксид железа", L"Толины", L"Метановый лед", L"Аммиак"},
        1,
        L"Толины — органические соединения, образованные солнечным излучением на метане и азоте.",
        "pluto", 3, 20
    });
    
    questions.push_back({
        L"Есть ли у Плутона атмосфера?",
        {L"Нет", L"Тонкая азотная", L"Толстая метановая", L"Переменная"},
        3,
        L"У Плутона тонкая атмосфера, которая расширяется, когда он ближе к Солнцу, и сжимается, когда дальше.",
        "pluto", 3, 20
    });
    
    questions.push_back({
        L"Что такое 'сердце' на Плутоне?",
        {L"Ударный кратер", L"Вулкан", L"Ледяная равнина", L"Горный хребет"},
        2,
        L"Регион Томбо — это яркая область в форме сердца из азотного льда.",
        "pluto", 2, 15
    });
    
    std::cout << "Загружено " << questions.size() << " вопросов викторины" << std::endl;
}


void Quiz::startNewQuiz(const std::string& category, int questionCount) {
    selectRandomQuestions(category, questionCount);
    currentQuestion = 0;
    userAnswers.clear();
    originalUserAnswers.clear();
    retryQuestions.clear();
    retryMode = false;
    retryRequired = false;
    requiredCorrectAnswers = questionCount; // По умолчанию - все вопросы
    finished = false;
    startTime = static_cast<int>(time(nullptr));
    
    std::cout << "Started new quiz: " << category 
              << " (" << selectedQuestions.size() << " questions)" 
              << " Required correct: " << requiredCorrectAnswers << std::endl;
}

bool Quiz::submitAnswer(int answerIndex) {
    if (finished || currentQuestion >= static_cast<int>(selectedQuestions.size())) {
        return false;
    }
    
    // Проверяем, не отвечали ли уже на этот вопрос
    if (hasAnsweredCurrent()) {
        return false;
    }
    
    userAnswers.push_back(answerIndex);
    std::cout << "Submitted answer: " << answerIndex 
              << " for question " << currentQuestion + 1 
              << " (correct: " << selectedQuestions[currentQuestion].correctAnswer 
              << ")" << std::endl;
    return true;
}

void Quiz::nextQuestion() {
    // Проверяем, есть ли еще вопросы
    if (currentQuestion < static_cast<int>(selectedQuestions.size()) - 1) {
        // Переходим к следующему вопросу
        currentQuestion++;
        std::cout << "Moved to question " << currentQuestion + 1 
                  << "/" << selectedQuestions.size() << std::endl;
    } else {
        // Это последний вопрос, завершаем квиз
        finished = true;
        
        // Проверяем, нужно ли повторение
        int correctCount = 0;
        for (size_t i = 0; i < selectedQuestions.size() && i < userAnswers.size(); ++i) {
            if (userAnswers[i] == selectedQuestions[i].correctAnswer) {
                correctCount++;
            }
        }
        
        // Сохраняем оригинальные ответы
        originalUserAnswers = userAnswers;
        
        // Проверяем, нужно ли повторение
        if (correctCount < requiredCorrectAnswers) {
            retryRequired = true;
            std::cout << "Quiz finished. Only " << correctCount << "/" 
                      << requiredCorrectAnswers << " correct answers. Retry required." << std::endl;
        } else {
            retryRequired = false;
            currentResult = finishQuiz();
            std::cout << "Quiz finished. Results calculated." << std::endl;
        }
    }
}

Quiz::QuizResult Quiz::finishQuiz() {
    finished = true;
    
    QuizResult result;
    result.totalQuestions = static_cast<int>(selectedQuestions.size());
    result.questions = selectedQuestions;
    result.category = selectedQuestions.empty() ? "" : selectedQuestions[0].category;
    
    result.correctAnswers = 0;
    result.answers.resize(selectedQuestions.size());
    
    const std::vector<int>& answersToUse = retryMode ? userAnswers : originalUserAnswers;
    
    for (size_t i = 0; i < selectedQuestions.size() && i < answersToUse.size(); ++i) {
        bool correct = (answersToUse[i] == selectedQuestions[i].correctAnswer);
        result.answers[i] = correct;
        if (correct) {
            result.correctAnswers++;
            result.score += selectedQuestions[i].points;
        }
    }

    int maxPossibleScore = 0;
    for (const auto& q : selectedQuestions) {
        maxPossibleScore += q.points;
    }

    if (result.totalQuestions > 0) {
        result.accuracy = (static_cast<float>(result.correctAnswers) / 
                          static_cast<float>(result.totalQuestions)) * 100.0f;
    } else {
        result.accuracy = 0.0f;
    }
    
    std::cout << "Quiz completed! Result: " 
              << result.correctAnswers << "/" << result.totalQuestions
              << ", score: " << result.score << std::endl;
    
    return result;
}

const Quiz::Question& Quiz::getCurrentQuestion() const {
    static Question empty = {L"", {}, 0, L"", "", 0, 0};
    if (currentQuestion < static_cast<int>(selectedQuestions.size())) {
        return selectedQuestions[currentQuestion];
    }
    return empty;
}

std::vector<std::string> Quiz::getAvailableCategories() const {
    std::vector<std::string> categories;
    for (const auto& q : questions) {
        if (std::find(categories.begin(), categories.end(), q.category) == categories.end()) {
            categories.push_back(q.category);
        }
    }
    return categories;
}

void Quiz::selectRandomQuestions(const std::string& category, int count) {
    selectedQuestions.clear();
    
    std::vector<Question> filtered;
    for (const auto& q : questions) {
        if (category.empty() || q.category == category) {
            filtered.push_back(q);
        }
    }
    
    if (filtered.size() <= static_cast<size_t>(count)) {
        selectedQuestions = filtered;
        return;
    }
    
    std::vector<int> indices(filtered.size());
    std::iota(indices.begin(), indices.end(), 0);
    std::shuffle(indices.begin(), indices.end(), rng);
    
    for (int i = 0; i < count; ++i) {
        selectedQuestions.push_back(filtered[indices[i]]);
    }
}

void Quiz::startRetryIncorrectQuestions(int requiredCorrect) {
    retryMode = true;
    retryRequired = false;
    requiredCorrectAnswers = requiredCorrect;
    finished = false;
    currentQuestion = 0;
    
    // Подготавливаем вопросы для повторения
    prepareRetryQuestions();
    
    // Очищаем предыдущие ответы для повторного прохождения
    userAnswers.clear();
    
    std::cout << "Starting retry mode with " << retryQuestions.size() 
              << " incorrect questions" << std::endl;
}

void Quiz::prepareRetryQuestions() {
    retryQuestions.clear();
    
    // Находим вопросы, на которые ответили неправильно
    for (size_t i = 0; i < selectedQuestions.size() && i < originalUserAnswers.size(); ++i) {
        if (originalUserAnswers[i] != selectedQuestions[i].correctAnswer) {
            retryQuestions.push_back(selectedQuestions[i]);
        }
    }
    
    // Если есть неправильные ответы, используем их
    if (!retryQuestions.empty()) {
        selectedQuestions = retryQuestions;
    } else {
        // Если все ответы правильные, оставляем исходные вопросы
        retryMode = false;
    }
}
